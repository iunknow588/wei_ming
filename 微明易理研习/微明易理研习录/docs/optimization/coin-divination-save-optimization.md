# 铜钱起卦保存逻辑优化

## 优化目标

修改铜钱起卦页面的卦象保存逻辑，确保每个卦象只能保存一次，防止重复保存相同数据。

## 优化内容

### 1. 保存状态管理

**新增数据字段：**
```javascript
data: {
  // 当前卦象是否已保存
  isCurrentGuaSaved: false,
  
  // 当前卦象的爻值数组（用于判断是否重复）
  currentGuaYaoValues: null
}
```

**状态说明：**
- `isCurrentGuaSaved`: 标记当前卦象是否已保存
- `currentGuaYaoValues`: 存储当前卦象的爻值数组，用于判断是否重复

### 2. 防重复保存逻辑

**保存前检查：**
1. 检查是否完成全部六次摇卦
2. 检查当前卦象是否已经保存过
3. 比较爻值数组是否相同
4. 如果相同则提示"当前卦象已保存，无需重复保存"

**保存后更新状态：**
```javascript
saveGuaHistoryRecord(yaoValues, 'coin')
  .then(() => {
    // 标记当前卦象已保存
    this.setData({
      isCurrentGuaSaved: true,
      currentGuaYaoValues: yaoValues
    });
  });
```

### 3. 重置保存状态

**重新起卦时重置：**
- 在 `initCoins()` 方法中重置保存状态
- 在 `onNewDivination()` 方法中重置保存状态
- 确保每次重新起卦后可以重新保存

### 4. 用户界面优化

**保存按钮位置：**
- 保存按钮放置在摇钱起卦按钮的同一行旁边
- 两个按钮并排显示，布局更加紧凑
- 保存按钮始终存在，但根据状态进行灰化处理

**保存按钮状态：**
- 未完成摇卦：灰色禁用状态，显示"💾 保存卦象"
- 未保存：绿色按钮，显示"💾 保存卦象"
- 已保存：灰色按钮，显示"✅ 已保存"

**按钮样式：**
```css
.save-btn {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.save-btn.saved {
  background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
}

.save-btn.disabled {
  background: #cccccc;
  opacity: 0.6;
  pointer-events: none;
}
```

**布局优化：**
- 操作按钮区域使用 `flex-wrap: nowrap` 确保按钮在同一行
- 按钮间距设置为15px，布局更加紧凑
- 按钮使用 `flex: 1` 和 `max-width: 140px` 实现等宽布局
- 图标和文字尺寸适当缩小，适应并排显示

**底部按钮响应式优化：**
- 底部三个按钮使用 `flex-wrap: wrap` 支持换行
- 按钮使用 `flex: 1` 自适应宽度，设置 `min-width` 和 `max-width` 限制
- 在不同屏幕尺寸下自动调整按钮大小和间距
- 小屏幕下按钮尺寸和文字自动缩小，确保不超出屏幕范围

### 5. 移除自动保存

**修改内容：**
- 移除 `onResultAnalysis()` 中的自动保存逻辑
- 改为用户手动控制保存时机
- 提供更清晰的用户反馈

## 技术实现

### 保存流程
1. 用户点击"保存卦象"按钮
2. 检查是否完成全部六次摇卦
3. 提取当前爻值数组
4. 检查是否已经保存过相同的卦象
5. 如果未保存过，则保存并更新状态
6. 如果已保存过，则提示用户

### 状态重置流程
1. 用户点击"重新起卦"或"重新摇卦"
2. 调用 `initCoins()` 方法
3. 重置所有相关状态
4. 允许用户重新保存新的卦象

### 重复检测逻辑
```javascript
// 检查是否已经保存过相同的卦象
if (this.data.isCurrentGuaSaved && this.data.currentGuaYaoValues) {
  const isSameGua = JSON.stringify(yaoValues) === JSON.stringify(this.data.currentGuaYaoValues);
  if (isSameGua) {
    // 提示用户无需重复保存
    return;
  }
}
```

## 优化效果

### 1. 用户体验提升
- 清晰的保存状态反馈
- 防止误操作重复保存
- 直观的按钮状态变化

### 2. 数据管理优化
- 避免重复的历史记录
- 减少存储空间浪费
- 提高数据质量

### 3. 操作逻辑清晰
- 保存时机由用户控制
- 状态管理更加明确
- 错误提示更加友好

## 使用说明

### 保存卦象
1. 完成全部六次摇卦
2. 点击"保存卦象"按钮
3. 系统自动保存并显示"已保存"状态

### 重新起卦
1. 点击"重新起卦"或"重新摇卦"
2. 系统重置所有状态
3. 可以重新保存新的卦象

### 注意事项
1. 只有完成全部六次摇卦才能保存
2. 相同的卦象只能保存一次
3. 重新起卦后可以重新保存
4. 保存状态在页面刷新后会重置

## 后续优化建议

1. **持久化保存状态**：将保存状态持久化到本地存储
2. **批量管理**：提供批量删除历史记录功能
3. **数据导出**：支持历史记录导出功能
4. **统计分析**：提供起卦统计和分析功能 