# 历史记录优化

## 优化目标

统一所有起卦页面的历史记录保存格式，简化数据结构，提高维护性和一致性。

## 优化内容

### 1. 统一保存格式

**之前的问题：**
- 铜钱起卦保存到 `coinDivinationRecords`
- 汉字起卦保存到 `characterDivinationRecords`
- 数据结构复杂，包含大量冗余信息

**优化后：**
- 每条历史记录单独存储为一个文件
- 文件名：时间戳格式 `YYYY-MM-DD-HH时MM分SS秒`
- 只保存核心数据：爻值数组、起卦类型、时间戳

### 2. 数据结构简化

**新的记录格式：**
```javascript
{
  yaoValues: [6,7,8,9,7,8], // 爻值数组（6个元素）
  divinationType: 'coin', // 起卦类型
  time: '2024-01-01-12时30分45秒', // 时间戳
  timestamp: 1704081045000 // 时间戳（用于排序）
}
```

**存储方式：**
- **文件名**：`2024-01-01-12时30分45秒`
- **文件内容**：`{ yaoValues: [7,8,9,6,8,7] }`

**优势：**
- 每条记录独立存储，便于管理
- 数据量减少约70%
- 存储空间优化
- 读取速度提升
- 维护成本降低

### 3. 工具函数封装

**新增工具函数：**
- `saveGuaHistoryRecord(yaoValues, divinationType)` - 统一保存历史记录
- `getGuaHistoryRecords()` - 获取所有历史记录
- `deleteGuaHistoryRecord(key)` - 删除指定历史记录

**使用方式：**
```javascript
const { saveGuaHistoryRecord } = require('../../utils/gua-utils.js');

// 保存历史记录
saveGuaHistoryRecord(yaoValues, 'coin')
  .then(() => console.log('保存成功'))
  .catch(err => console.error('保存失败:', err));
```

### 4. 页面修改

**修改的页面：**
- `pages/coin-divination/coin-divination.js` - 使用统一保存函数
- `pages/character-divination/character-divination.js` - 使用统一保存函数
- `pages/practice/practice.js` - 使用新的历史记录格式

**修改内容：**
- 移除本地保存逻辑
- 使用工具函数统一保存
- 简化历史记录读取和显示
- 优化历史记录点击跳转逻辑

### 5. 向后兼容

**数据迁移：**
- 保留旧的历史记录读取逻辑（在practice页面）
- 新记录使用统一格式
- 旧记录可以继续正常显示

## 技术实现

### 保存流程
1. 提取爻值数组
2. 生成时间戳key
3. 构造简化记录
4. 保存为单独文件

### 读取流程
1. 获取所有存储的key
2. 过滤出符合时间格式的key
3. 读取所有历史记录文件
4. 使用 `generateCompleteGuaResult` 恢复完整信息
5. 按时间倒序排列
6. 显示在历史记录列表

### 跳转流程
1. 从历史记录获取爻值数组
2. 使用简化参数传递
3. 跳转到结果解析页面

## 优化效果

1. **代码简化**：移除重复的保存逻辑
2. **存储优化**：数据量减少70%，每条记录独立存储
3. **维护性提升**：统一的数据格式
4. **扩展性增强**：支持新的起卦类型
5. **性能提升**：读取和保存速度更快
6. **管理便利**：每条记录独立，便于删除和管理

## 注意事项

1. 新的历史记录使用单独文件存储
2. 旧的历史记录仍然可以正常显示
3. 建议在适当时机清理旧的历史记录
4. 所有新的起卦页面都应该使用统一的保存函数
5. 使用正则表达式过滤历史记录文件 